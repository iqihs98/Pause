# 架构说明书

**版本**：v1.0
**范围**：MVP（呼吸引导 + iOS/watch 同步 + Watch 心率采集 + iOS 展示与存储）
**平台**：iOS / watchOS
**技术栈**：SwiftUI · Swift Concurrency · WatchConnectivity · HealthKit ·（SwiftData/CoreData/JSON 任选其一）

---

## 1. 架构目标（Goals）

* **共享核心逻辑**：呼吸节奏、倒计时、状态机在 Shared 层统一实现，iOS/watch 复用。
* **模块边界清晰**：心率采集只发生在 watch 端；iOS 负责持久化与历史展示。
* **同步可控**：iOS/watch 的会话状态一致，处理断连/延迟/重复消息。
* **可测试性**：BreathingEngine 可单测（不依赖 UI、HealthKit、WCSession）。
* **可扩展**：后续加入触觉提示、音频提示、更多呼吸模式、统计图表时不推翻结构。

---

## 2. 非目标（Non-goals）

* 账号系统、云同步、跨设备多端合并
* 复杂课程系统、内容管理
* HealthKit 全面数据读写（MVP 只关注心率采样展示）

---

## 3. 总体架构概览（High-level Overview）

### 3.1 分层原则

采用“Domain/Core 与 Platform/Service 分离”的结构：

* **Domain（Shared）**：纯逻辑、纯数据结构、状态机；不依赖 UI / HealthKit / WatchConnectivity。
* **Platform Services（iOS/watch）**：与系统 API 交互（HealthKit、WCSession、存储）。
* **App/UI（iOS/watch）**：SwiftUI 页面 + ViewModel，把 Domain 的状态渲染出来。

### 3.2 依赖方向（Dependency Rule）

> UI/ViewModel → Domain（Shared）
> UI/ViewModel → Platform Services
> Platform Services ↔ 系统 API（HealthKit/WCSession/Storage）
> **Domain 禁止依赖** Platform Services 与系统 API

**禁止事项**

* SharedKit（Domain）里**不允许 import** HealthKit / WatchConnectivity / UIKit / WatchKit
* View 不直接使用 HealthKit/WCSession，统一通过 Service/Client 层

---

## 4. 模块划分（Modules）

### 4.1 SharedKit（共享核心模块）

**职责**：呼吸会话的核心逻辑与数据模型（可跨平台复用）。
**包含**

* `BreathingEngine`：状态机、计时、进度、倒计时、start/pause/resume/stop
* `BreathingPattern`：吸/停/呼参数
* `BreathingSession`：会话结构（id、时间、pattern）
* `HeartRateSample`：心率样本结构（timestamp、bpm）
* `SessionSummary`：统计结果（duration、avg/min/max）
* 纯工具：时间格式化、数值计算（均值/极值）

**对外输出**

* `EngineState`（供 UI 渲染）
* `EngineEvent`（供同步与日志）
* 计算后的 `SessionSummary`

---

### 4.2 WatchApp（watchOS 端）

**职责**：呼吸 UI + 心率采集 + 同步发送。
**子模块**

* `HeartRateService`（HealthKit）

  * 请求授权
  * 采集心率样本流
  * 停止采集与资源释放
* `ConnectivityClient`（WatchConnectivity）

  * 向 iOS 发送：会话状态、心率样本、会话总结
  * 处理发送失败与重试（按策略）
* `WatchSessionCoordinator`

  * 绑定 SharedKit 的 `BreathingEngine`
  * 管理会话生命周期（开始/暂停/结束）
  * 将 engine 状态与心率样本打包发送给 iOS
* `WatchUI`（SwiftUI Views + Watch ViewModels）

---

### 4.3 iOSApp（iOS 端）

**职责**：呼吸 UI + 接收 watch 数据 + 持久化 + 历史展示。
**子模块**

* `ConnectivityHost`（WatchConnectivity）

  * 接收来自 watch 的消息（state/sample/summary）
  * 将消息路由到 Store/Engine/UI
* `SessionStore`（Persistence）

  * 保存会话与样本（或只保存 summary，按策略）
  * 提供历史列表查询
* `iOSSessionCoordinator`

  * iOS 发起会话时负责创建 sessionId、驱动 Shared engine、同步给 watch
  * watch 发起会话时，负责被动展示与保存
* `iOSUI`（SwiftUI Views + iOS ViewModels）

---

## 5. 推荐目录结构（Project Structure）

```txt
ISO-Breathing/
├─ SharedKit/
│  ├─ Domain/
│  │  ├─ BreathingEngine.swift
│  │  ├─ Models/
│  │  │  ├─ BreathingPattern.swift
│  │  │  ├─ BreathingSession.swift
│  │  │  ├─ HeartRateSample.swift
│  │  │  └─ SessionSummary.swift
│  │  └─ Utils/
│  └─ Tests/
│     └─ BreathingEngineTests.swift
│
├─ iOSApp/
│  ├─ UI/
│  ├─ ViewModels/
│  ├─ Coordinators/
│  ├─ Services/
│  │  ├─ ConnectivityHost.swift
│  │  └─ SessionStore.swift
│  └─ Resources/
│
└─ WatchApp/
   ├─ UI/
   ├─ ViewModels/
   ├─ Coordinators/
   └─ Services/
      ├─ HeartRateService.swift
      └─ ConnectivityClient.swift
```

---

## 6. 关键组件职责与边界（Responsibilities）

### 6.1 BreathingEngine（SharedKit）

* 输入：`start(pattern, duration)`、`pause()`、`resume()`、`stop()`
* 输出：`EngineState`（phase、progress、remainingSeconds、isPaused 等）
* 时间推进：由外部 tick（Timer）或内部 Clock（建议可注入，便于测试）

> **约束**：Engine 不知道“watch/iOS”，也不知道“心率”。

---

### 6.2 HeartRateService（Watch）

* 只负责 HealthKit 授权与采样
* 输出 `HeartRateSample` 流
* 不参与会话状态机

---

### 6.3 Connectivity（iOS/watch）

* 负责消息的发送/接收与幂等处理
* 只处理“通信”，不做 UI 逻辑
* 统一消息格式：`type + sessionId + timestamp + payload + version`

---

### 6.4 SessionStore（iOS）

* 写入：会话结束时保存 summary（可选保存 samples）
* 读取：历史列表、详情
* 不依赖 UI

---

## 7. 并发与线程模型（Concurrency Model）

* UI 更新：`@MainActor`
* HealthKit 回调：可能在后台线程，进入 ViewModel 前切回主线程
* WatchConnectivity 回调：可能在后台线程，进入 Store/VM 前统一切回主线程或使用 Actor 串行化

**推荐做法**

* iOS：`ConnectivityHost` 用一个 `actor` 进行消息串行处理，避免并发写入 Store。
* Shared：`BreathingEngine` 运行在 `@MainActor`（简单）或 `actor`（更严谨），MVP 推荐先 `@MainActor`。

---

## 8. 数据流（Data Flow）

### 8.1 iPhone 发起会话（主模式）

* iOS UI → iOSSessionCoordinator → Shared BreathingEngine（驱动状态）
* iOSSessionCoordinator → ConnectivityHost/Client → watch（同步状态）
* watch：HeartRateService → WatchSessionCoordinator → ConnectivityClient → iOS
* iOS：ConnectivityHost → ViewModel（展示心率）+ SessionStore（结束后保存）

### 8.2 Watch 发起会话（备模式）

* watch UI → WatchSessionCoordinator → Shared engine + HeartRateService
* watch → iOS 同步状态/样本/总结
* iOS → 被动展示 + 保存

---

## 9. 错误处理与降级（Fault Handling）

* Watch 不可达：iOS 仍可进行呼吸引导（无心率）
* 心率未授权：watch 提示授权；若拒绝则继续呼吸引导但隐藏心率
* 同步延迟/重复：以 `sessionId` + `timestamp` 做幂等过滤（详见 Sync Spec，后续单独文档）

---

## 10. 扩展点（Future Extensions）

* 触觉提示：WatchSessionCoordinator 增加 HapticsService（独立 Service）
* 音频提示：iOS 增加 AudioService（独立 Service）
* 多模式呼吸：Shared 增加 Pattern presets 与自定义配置
* 统计图表：iOS 增加 Analytics 模块（不侵入 engine）

---

## 11. 开发顺序建议（Implementation Order）

1. SharedKit：BreathingEngine + Models + 单元测试
2. iOS：单端呼吸会话 UI 跑通（无 watch）
3. watch：呼吸 UI + HeartRateService（本地展示心率）
4. Connectivity：状态/样本/总结的收发与最小幂等
5. iOS SessionStore：保存与历史页面

---

## 12. 待补充文档（Next Docs）

* `SYNC_SPEC.md`：同步时序图、幂等策略、断线恢复（强烈建议）
* `STATE_MACHINE.md`：Engine 状态转移表与 tick 逻辑（强烈建议）
* `INTERFACES.md`：每个模块对外 protocol 契约（建议）

---

如果你认可这份 Architecture Doc，下一步我建议我直接给你补齐最关键的两份配套文档之一（都能立刻提升编码效率）：

* **SYNC_SPEC.md**（WatchConnectivity 的时序 + 幂等 + 断连恢复）
* **STATE_MACHINE.md**（BreathingEngine 的状态转移表 + 伪代码/接口）

你想先做哪一个？（我会直接给你可复制版本）


